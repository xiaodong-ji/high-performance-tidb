# 任务描述
- 分值：300
- 题目描述：
使用 sysbench、go-ycsb 和 go-tpc 分别对 TiDB 进行测试并且产出测试报告。

- 测试报告需要包括以下内容：
```
* 部署环境的机器配置(CPU、内存、磁盘规格型号)，拓扑结构(TiDB、TiKV 各部署于哪些节点)
* 调整过后的 TiDB 和 TiKV 配置
* 测试输出结果
* 关键指标的监控截图
  * TiDB Query Summary 中的 qps 与 duration
  * TiKV Details 面板中 Cluster 中各 server 的 CPU 以及 QPS 指标
  * TiKV Details 面板中 grpc 的 qps 以及 duration

输出：写出你对该配置与拓扑环境和 workload 下 TiDB 集群负载的分析，提出你认为的 TiDB 的性能的瓶颈所在(能提出大致在哪个模块即可)
```
- 截止时间：下周二（8.25）24:00:00(逾期提交不给分)


# 任务过程
### 环境描述
| 组件 | CPU（核）| 内存（GB）| 存储类型 | 网络 | 操作系统 | IP 地址 |
| :-----:| :----: | :----: | :----: | :----: | :----: | :----: |
| TiDB | 4 | 8 | SAS | 千兆网卡 | CentOS 7.5 | 192.168.0.19 |
| PD | 4 | 8 | SAS | 千兆网卡 | CentOS 7.5 | 192.168.0.19 |
| PD | 4 | 8 | SAS | 千兆网卡 | CentOS 7.5 | 192.168.0.18 |
| PD | 4 | 8 | SAS | 千兆网卡 | CentOS 7.5 | 192.168.0.17 |
| TiKV | 8 | 8 | SAS | 千兆网卡 | CentOS 7.5 | 192.168.0.16 |
| TiKV | 8 | 8 | SAS | 千兆网卡 | CentOS 7.5 | 192.168.0.15 |
| TiKV | 8 | 8 | SAS | 千兆网卡 | CentOS 7.5 | 192.168.0.14 |
| TiFlash | 4 | 8 | SAS | 千兆网卡 | CentOS 7.5 | 192.168.0.17 |

### TiDB 集群部署
1. 安装 TiUP 组件
```
// 安装 TiUP 工具
# useradd tidb
# su - tidb
$ curl --proto '=https' --tlsv1.2 -sSf https://tiup-mirrors.pingcap.com/install.sh | sh
$ source /home/tidb/.bash_profile
$ which tiup 
~/.tiup/bin/tiup

// 安装 TiUP cluster 组件
$ tiup cluster

// 更新 TiUP cluster 组件
$ tiup update --self && tiup update cluster

// 查看 TiUP cluster 版本信息
$ tiup --binary cluster
/home/tidb/.tiup/components/cluster/v1.0.9/tiup-cluster
```

2. 编辑初始化配置文件
```
$ vi topology.yaml
# # Global variables are applied to all deployments and used as the default value of
# # the deployments if a specific deployment value is missing.
global:
  user: "tidb"
  ssh_port: 22
  deploy_dir: "/tidb-deploy"
  data_dir: "/tidb-data"

# # Monitored variables are applied to all the machines.
monitored:
  node_exporter_port: 9100
  blackbox_exporter_port: 9115
  # deploy_dir: "/tidb-deploy/monitored-9100"
  # data_dir: "/tidb-data/monitored-9100"
  # log_dir: "/tidb-deploy/monitored-9100/log"

# # Server configs are used to specify the runtime configuration of TiDB components.
# # All configuration items can be found in TiDB docs:
# # - TiDB: https://pingcap.com/docs/stable/reference/configuration/tidb-server/configuration-file/
# # - TiKV: https://pingcap.com/docs/stable/reference/configuration/tikv-server/configuration-file/
# # - PD: https://pingcap.com/docs/stable/reference/configuration/pd-server/configuration-file/
# # All configuration items use points to represent the hierarchy, e.g:
# #   readpool.storage.use-unified-pool
# #      
# # You can overwrite this configuration via the instance-level `config` field.

server_configs:
  tidb:
    log.slow-threshold: 300
  tikv:
    # server.grpc-concurrency: 4
    # raftstore.apply-pool-size: 2
    # raftstore.store-pool-size: 2
    # rocksdb.max-sub-compactions: 1
    # storage.block-cache.capacity: "16GB"
    # readpool.unified.max-thread-count: 12
    readpool.storage.use-unified-pool: false
    readpool.coprocessor.use-unified-pool: true
  pd:
    schedule.leader-schedule-limit: 4
    schedule.region-schedule-limit: 2048
    schedule.replica-schedule-limit: 64
    replication.enable-placement-rules: true
  tiflash:
    # Maximum memory usage for processing a single query. Zero means unlimited.
    profiles.default.max_memory_usage: 10000000000
    # Maximum memory usage for processing all concurrently running queries on the server. Zero means unlimited.
    profiles.default.max_memory_usage_for_all_queries: 0

pd_servers:
  - host: 192.168.0.17
    # ssh_port: 22
    # name: "pd-1"
    # client_port: 2379
    # peer_port: 2380
    # deploy_dir: "/tidb-deploy/pd-2379"
    # data_dir: "/tidb-data/pd-2379"
    # log_dir: "/tidb-deploy/pd-2379/log"
    # numa_node: "0,1"
    # # The following configs are used to overwrite the `server_configs.pd` values.
    # config:
    #   schedule.max-merge-region-size: 20
    #   schedule.max-merge-region-keys: 200000
  - host: 192.168.0.18
  - host: 192.168.0.19
tidb_servers:
  - host: 192.168.0.19
    # ssh_port: 22
    # port: 4000
    # status_port: 10080
    # deploy_dir: "/tidb-deploy/tidb-4000"
    # log_dir: "/tidb-deploy/tidb-4000/log"
    # numa_node: "0,1"
    # # The following configs are used to overwrite the `server_configs.tidb` values.
    # config:
    #   log.slow-query-file: tidb-slow-overwrited.log
	# - host: 10.0.1.8
	# - host: 10.0.1.9
tikv_servers:
  - host: 192.168.0.14
    # ssh_port: 22
    # port: 20160
    # status_port: 20180
    # deploy_dir: "/tidb-deploy/tikv-20160"
    # data_dir: "/tidb-data/tikv-20160"
    # log_dir: "/tidb-deploy/tikv-20160/log"
    # numa_node: "0,1"
    # # The following configs are used to overwrite the `server_configs.tikv` values.
    # config:
    #   server.grpc-concurrency: 4
    #   server.labels: { zone: "zone1", dc: "dc1", host: "host1" }
  - host: 192.168.0.15
  - host: 192.168.0.16

tiflash_servers:
  - host: 192.168.0.17
    data_dir: /mtime/tidb/tidb-data/tiflash-9000
    deploy_dir: /mtime/tidb/tidb-deploy/tiflash-9000
    # ssh_port: 22
    # tcp_port: 9000
    # http_port: 8123
    # flash_service_port: 3930
    # flash_proxy_port: 20170
    # flash_proxy_status_port: 20292
    # metrics_port: 8234
    # deploy_dir: /tidb-deploy/tiflash-9000
    # numa_node: "0,1"
    # # The following configs are used to overwrite the `server_configs.tiflash` values.
    # config:
    #   logger.level: "info"
    # learner_config:
    #   log-level: "info"
    # - host: 10.0.1.12
    # - host: 10.0.1.13

monitoring_servers:
  - host: 192.168.0.18
    # ssh_port: 22
    # port: 9090
    # deploy_dir: "/tidb-deploy/prometheus-8249"
    # data_dir: "/tidb-data/prometheus-8249"
    # log_dir: "/tidb-deploy/prometheus-8249/log"

grafana_servers:
  - host: 192.168.0.18
    # port: 3000
    # deploy_dir: /tidb-deploy/grafana-3000

alertmanager_servers:
  - host: 192.168.0.18
    # ssh_port: 22
    # web_port: 9093
    # cluster_port: 9094
    # deploy_dir: "/tidb-deploy/alertmanager-9093"
    # data_dir: "/tidb-data/alertmanager-9093"
    # log_dir: "/tidb-deploy/alertmanager-9093/log"
```

3. 执行部署命令
```
$ tiup cluster deploy tidb-benchmark nightly ./topology.yaml --user root -p
```

4. 查看并启动 TiDB 集群
```
// 查看 TiUP 管理的集群情况
$ tiup cluster list
Starting component `cluster`: /home/tidb/.tiup/components/cluster/v1.0.9/tiup-cluster list
Name            User  Version  Path                                                      PrivateKey
----            ----  -------  ----                                                      ----------
tidb-benchmark  tidb  nightly  /home/tidb/.tiup/storage/cluster/clusters/tidb-benchmark  /home/tidb/.tiup/storage/cluster/clusters/tidb-benchmark/ssh/id_rsa

// 检查部署的 TiDB 集群情况
$ tiup cluster display tidb-benchmark

// 启动 TiDB 集群
$ tiup cluster start tidb-benchmark

// 验证 TiDB 集群状态
$ tiup cluster display tidb-benchmark

// 登录数据库
$ mysql -u root -h 192.168.0.19 -P 4000

// 访问 TiDB Dashboard
http://192.168.0.19:2379/dashboard

// 访问 Grafana 监控
http://192.168.0.18:3000/
```

### sysbench 性能测试
1. sysbench 工具安装
```
# yum -y install make automake libtool pkgconfig libaio-devel
# yum -y install mariadb-devel openssl-devel
# mkdir sysbench
# cd sysbench
# wget https://github.com/akopytov/sysbench/archive/1.0.20.tar.gz
# tar -zxvf 1.0.20.tar.gz 
# cd sysbench-1.0.20/
# ./autogen.sh 
# ./configure
# make -j
# make install
# sysbench --version
sysbench 1.0.20
```

2. sysbench 测试准备
- 创建数据库
```
# mysql -u root -h 192.168.0.19 -P 4000
mysql> create database sysbench;
```

- 创建配置文件
```
# vi config
mysql-host=192.168.0.19
mysql-port=4000
mysql-user=root
mysql-db=sysbench
time=600
threads=128
report-interval=10
db-driver=mysql
```

- 准备数据与预热
```
// 导入前设置为乐观事务模式
mysql> set global tidb_disable_txn_auto_retry=off;
mysql> set global tidb_txn_mode="optimistic";

// 使用 sysbench 工具生产数据
# sysbench --config-file=config oltp_point_select --tables=32 --table-size=100000 prepare

// 导入结束后再设置回悲观模式
mysql> set global tidb_disable_txn_auto_retry=on;
mysql> set global tidb_txn_mode="pessimistic";

// 数据预热与统计信息收集
SELECT COUNT(pad) FROM sbtest1 USE INDEX(k_1);
......
SELECT COUNT(pad) FROM sbtest32 USE INDEX(k_1);

ANALYZE TABLE sbtest1;
......
ANALYZE TABLE sbtest32;
```

3. sysbench 场景测试
- Point select 场景测试
```
# sysbench --config-file=config oltp_point_select --tables=32 --table-size=100000 run
sysbench 1.0.20 (using bundled LuaJIT 2.1.0-beta2)

Running the test with following options:
Number of threads: 128
Report intermediate results every 10 second(s)
Initializing random number generator from current time


Initializing worker threads...

Threads started!

[ 10s ] thds: 128 tps: 18361.47 qps: 18361.47 (r/w/o: 18361.47/0.00/0.00) lat (ms,95%): 12.52 err/s: 0.00 reconn/s: 0.00
[ 20s ] thds: 128 tps: 18899.74 qps: 18899.74 (r/w/o: 18899.74/0.00/0.00) lat (ms,95%): 11.87 err/s: 0.00 reconn/s: 0.00
[ 30s ] thds: 128 tps: 17917.60 qps: 17917.60 (r/w/o: 17917.60/0.00/0.00) lat (ms,95%): 12.98 err/s: 0.00 reconn/s: 0.00
......
[ 550s ] thds: 128 tps: 18388.91 qps: 18388.91 (r/w/o: 18388.91/0.00/0.00) lat (ms,95%): 12.75 err/s: 0.00 reconn/s: 0.00
[ 560s ] thds: 128 tps: 18819.55 qps: 18819.55 (r/w/o: 18819.55/0.00/0.00) lat (ms,95%): 12.30 err/s: 0.00 reconn/s: 0.00
[ 570s ] thds: 128 tps: 18461.26 qps: 18461.26 (r/w/o: 18461.26/0.00/0.00) lat (ms,95%): 12.52 err/s: 0.00 reconn/s: 0.00
[ 580s ] thds: 128 tps: 17546.61 qps: 17546.61 (r/w/o: 17546.61/0.00/0.00) lat (ms,95%): 12.52 err/s: 0.00 reconn/s: 0.00
[ 590s ] thds: 128 tps: 18062.17 qps: 18062.17 (r/w/o: 18062.17/0.00/0.00) lat (ms,95%): 12.30 err/s: 0.00 reconn/s: 0.00
[ 600s ] thds: 128 tps: 18511.14 qps: 18511.14 (r/w/o: 18511.14/0.00/0.00) lat (ms,95%): 12.52 err/s: 0.00 reconn/s: 0.00
SQL statistics:
    queries performed:
        read:                            11024052
        write:                           0
        other:                           0
        total:                           11024052
    transactions:                        11024052 (18371.10 per sec.)
    queries:                             11024052 (18371.10 per sec.)
    ignored errors:                      0      (0.00 per sec.)
    reconnects:                          0      (0.00 per sec.)

General statistics:
    total time:                          600.0717s
    total number of events:              11024052

Latency (ms):
         min:                                    2.19
         avg:                                    6.96
         max:                                  351.60
         95th percentile:                       12.30
         sum:                             76728218.24

Threads fairness:
    events (avg/stddev):           86125.4062/167.82
    execution time (avg/stddev):   599.4392/0.02
```

- Update index 场景测试
```
# sysbench --config-file=config oltp_update_index --tables=32 --table-size=100000 run
sysbench 1.0.20 (using bundled LuaJIT 2.1.0-beta2)

Running the test with following options:
Number of threads: 128
Report intermediate results every 10 second(s)
Initializing random number generator from current time


Initializing worker threads...

Threads started!

[ 10s ] thds: 128 tps: 371.19 qps: 371.19 (r/w/o: 0.00/371.19/0.00) lat (ms,95%): 590.56 err/s: 0.00 reconn/s: 0.00
[ 20s ] thds: 128 tps: 387.24 qps: 387.24 (r/w/o: 0.00/387.24/0.00) lat (ms,95%): 623.33 err/s: 0.00 reconn/s: 0.00
[ 30s ] thds: 128 tps: 414.30 qps: 414.30 (r/w/o: 0.00/414.30/0.00) lat (ms,95%): 467.30 err/s: 0.00 reconn/s: 0.00
......
[ 550s ] thds: 128 tps: 364.60 qps: 364.60 (r/w/o: 0.00/364.60/0.00) lat (ms,95%): 590.56 err/s: 0.00 reconn/s: 0.00
[ 560s ] thds: 128 tps: 382.80 qps: 382.80 (r/w/o: 0.00/382.80/0.00) lat (ms,95%): 559.50 err/s: 0.00 reconn/s: 0.00
[ 570s ] thds: 128 tps: 395.50 qps: 395.50 (r/w/o: 0.00/395.50/0.00) lat (ms,95%): 520.62 err/s: 0.00 reconn/s: 0.00
[ 580s ] thds: 128 tps: 380.30 qps: 380.30 (r/w/o: 0.00/380.30/0.00) lat (ms,95%): 520.62 err/s: 0.00 reconn/s: 0.00
[ 590s ] thds: 128 tps: 383.60 qps: 383.60 (r/w/o: 0.00/383.60/0.00) lat (ms,95%): 580.02 err/s: 0.00 reconn/s: 0.00
[ 600s ] thds: 128 tps: 377.40 qps: 377.40 (r/w/o: 0.00/377.40/0.00) lat (ms,95%): 549.52 err/s: 0.00 reconn/s: 0.00
SQL statistics:
    queries performed:
        read:                            0
        write:                           204333
        other:                           0
        total:                           204333
    transactions:                        204333 (340.20 per sec.)
    queries:                             204333 (340.20 per sec.)
    ignored errors:                      0      (0.00 per sec.)
    reconnects:                          0      (0.00 per sec.)

General statistics:
    total time:                          600.6143s
    total number of events:              204333

Latency (ms):
         min:                                   87.25
         avg:                                  375.96
         max:                                 8997.53
         95th percentile:                      634.66
         sum:                             76820773.29

Threads fairness:
    events (avg/stddev):           1596.3516/13.83
    execution time (avg/stddev):   600.1623/0.10
```

- Read only 场景测试
```
# sysbench --config-file=config oltp_read_only --tables=32 --table-size=100000 run
sysbench 1.0.20 (using bundled LuaJIT 2.1.0-beta2)

Running the test with following options:
Number of threads: 128
Report intermediate results every 10 second(s)
Initializing random number generator from current time


Initializing worker threads...

Threads started!

[ 10s ] thds: 128 tps: 457.01 qps: 7421.03 (r/w/o: 6494.92/0.00/926.10) lat (ms,95%): 325.98 err/s: 0.00 reconn/s: 0.00
[ 20s ] thds: 128 tps: 356.57 qps: 5691.47 (r/w/o: 4978.53/0.00/712.93) lat (ms,95%): 520.62 err/s: 0.00 reconn/s: 0.00
[ 30s ] thds: 128 tps: 457.71 qps: 7312.92 (r/w/o: 6397.71/0.00/915.22) lat (ms,95%): 344.08 err/s: 0.00 reconn/s: 0.00
......
[ 560s ] thds: 128 tps: 455.00 qps: 7309.53 (r/w/o: 6398.33/0.00/911.20) lat (ms,95%): 344.08 err/s: 0.00 reconn/s: 0.00
[ 570s ] thds: 128 tps: 459.81 qps: 7346.18 (r/w/o: 6426.67/0.00/919.51) lat (ms,95%): 337.94 err/s: 0.00 reconn/s: 0.00
[ 580s ] thds: 128 tps: 466.30 qps: 7462.50 (r/w/o: 6530.00/0.00/932.50) lat (ms,95%): 331.91 err/s: 0.00 reconn/s: 0.00
[ 590s ] thds: 128 tps: 457.91 qps: 7331.58 (r/w/o: 6414.97/0.00/916.61) lat (ms,95%): 337.94 err/s: 0.00 reconn/s: 0.00
[ 600s ] thds: 128 tps: 459.49 qps: 7354.30 (r/w/o: 6436.11/0.00/918.19) lat (ms,95%): 331.91 err/s: 0.00 reconn/s: 0.00
SQL statistics:
    queries performed:
        read:                            3856076
        write:                           0
        other:                           550868
        total:                           4406944
    transactions:                        275434 (458.89 per sec.)
    queries:                             4406944 (7342.26 per sec.)
    ignored errors:                      0      (0.00 per sec.)
    reconnects:                          0      (0.00 per sec.)

General statistics:
    total time:                          600.2120s
    total number of events:              275434

Latency (ms):
         min:                                   75.47
         avg:                                  278.87
         max:                                  807.93
         95th percentile:                      337.94
         sum:                             76811293.20

Threads fairness:
    events (avg/stddev):           2151.8281/3.69
    execution time (avg/stddev):   600.0882/0.06
```

- Write only 场景测试
```
# sysbench --config-file=config oltp_write_only --tables=32 --table-size=100000 run
sysbench 1.0.20 (using bundled LuaJIT 2.1.0-beta2)

Running the test with following options:
Number of threads: 128
Report intermediate results every 10 second(s)
Initializing random number generator from current time


Initializing worker threads...

Threads started!

[ 10s ] thds: 128 tps: 166.91 qps: 1046.66 (r/w/o: 0.00/700.14/346.52) lat (ms,95%): 995.51 err/s: 0.00 reconn/s: 0.00
[ 20s ] thds: 128 tps: 163.01 qps: 975.28 (r/w/o: 0.00/649.15/326.13) lat (ms,95%): 1401.61 err/s: 0.00 reconn/s: 0.00
[ 30s ] thds: 128 tps: 164.00 qps: 982.99 (r/w/o: 0.00/654.99/328.00) lat (ms,95%): 1352.03 err/s: 0.00 reconn/s: 0.00
......
[ 550s ] thds: 128 tps: 132.80 qps: 796.41 (r/w/o: 0.00/530.41/266.00) lat (ms,95%): 1258.08 err/s: 0.00 reconn/s: 0.00
[ 560s ] thds: 128 tps: 132.90 qps: 794.89 (r/w/o: 0.00/529.49/265.40) lat (ms,95%): 4599.99 err/s: 0.00 reconn/s: 0.00
[ 570s ] thds: 128 tps: 169.40 qps: 1016.19 (r/w/o: 0.00/676.99/339.20) lat (ms,95%): 1213.57 err/s: 0.00 reconn/s: 0.00
[ 580s ] thds: 128 tps: 174.70 qps: 1043.02 (r/w/o: 0.00/693.61/349.41) lat (ms,95%): 1129.24 err/s: 0.00 reconn/s: 0.00
[ 590s ] thds: 128 tps: 160.80 qps: 973.19 (r/w/o: 0.00/651.60/321.60) lat (ms,95%): 1235.62 err/s: 0.00 reconn/s: 0.00
[ 600s ] thds: 128 tps: 168.80 qps: 1006.51 (r/w/o: 0.00/669.01/337.50) lat (ms,95%): 1170.65 err/s: 0.00 reconn/s: 0.00
SQL statistics:
    queries performed:
        read:                            0
        write:                           382172
        other:                           191086
        total:                           573258
    transactions:                        95543  (158.93 per sec.)
    queries:                             573258 (953.60 per sec.)
    ignored errors:                      0      (0.00 per sec.)
    reconnects:                          0      (0.00 per sec.)

General statistics:
    total time:                          601.1503s
    total number of events:              95543

Latency (ms):
         min:                                  303.12
         avg:                                  804.33
         max:                                 6695.11
         95th percentile:                     1280.93
         sum:                             76848535.01

Threads fairness:
    events (avg/stddev):           746.4297/4.03
    execution time (avg/stddev):   600.3792/0.24
```

- Read Write 场景测试
```
# sysbench --config-file=config oltp_read_write --tables=32 --table-size=100000 run
sysbench 1.0.20 (using bundled LuaJIT 2.1.0-beta2)

Running the test with following options:
Number of threads: 128
Report intermediate results every 10 second(s)
Initializing random number generator from current time


Initializing worker threads...

Threads started!

[ 10s ] thds: 128 tps: 127.53 qps: 2754.45 (r/w/o: 1957.87/528.72/267.86) lat (ms,95%): 1479.41 err/s: 0.00 reconn/s: 0.00
[ 20s ] thds: 128 tps: 124.61 qps: 2493.92 (r/w/o: 1740.65/504.14/249.12) lat (ms,95%): 1533.66 err/s: 0.00 reconn/s: 0.00
[ 30s ] thds: 128 tps: 124.40 qps: 2469.16 (r/w/o: 1723.77/497.09/248.30) lat (ms,95%): 1618.78 err/s: 0.00 reconn/s: 0.00
......
[ 560s ] thds: 128 tps: 115.60 qps: 2308.43 (r/w/o: 1615.32/462.31/230.80) lat (ms,95%): 1771.29 err/s: 0.00 reconn/s: 0.00
[ 570s ] thds: 128 tps: 118.80 qps: 2385.94 (r/w/o: 1669.33/478.61/238.00) lat (ms,95%): 1708.63 err/s: 0.00 reconn/s: 0.00
[ 580s ] thds: 128 tps: 107.20 qps: 2132.36 (r/w/o: 1493.97/423.99/214.40) lat (ms,95%): 1869.60 err/s: 0.00 reconn/s: 0.00
[ 590s ] thds: 128 tps: 110.70 qps: 2218.00 (r/w/o: 1555.20/441.40/221.40) lat (ms,95%): 1803.47 err/s: 0.00 reconn/s: 0.00
[ 600s ] thds: 128 tps: 114.80 qps: 2277.97 (r/w/o: 1586.98/461.59/229.40) lat (ms,95%): 1836.24 err/s: 0.00 reconn/s: 0.00
SQL statistics:
    queries performed:
        read:                            858788
        write:                           245368
        other:                           122684
        total:                           1226840
    transactions:                        61342  (102.03 per sec.)
    queries:                             1226840 (2040.51 per sec.)
    ignored errors:                      0      (0.00 per sec.)
    reconnects:                          0      (0.00 per sec.)

General statistics:
    total time:                          601.2381s
    total number of events:              61342

Latency (ms):
         min:                                  414.46
         avg:                                 1253.17
         max:                                12701.05
         95th percentile:                     2778.39
         sum:                             76872112.82

Threads fairness:
    events (avg/stddev):           479.2344/5.91
    execution time (avg/stddev):   600.5634/0.37
```

### go-ycsb 性能测试
1. go-ycsb 工具安装
```
# git clone https://github.com/pingcap/go-ycsb.git
# cd go-ycsb/
# make
```

2. 导入数据并测试不同负载类型
- 导入数据
```
# ./bin/go-ycsb load mysql -P workloads/workloada -p recordcount=10000 -p mysql.host=192.168.0.19 -p mysql.port=4000 --threads 6
***************** properties *****************
"readproportion"="0.5"
"recordcount"="10000"
"dotransactions"="false"
"readallfields"="true"
"workload"="core"
"updateproportion"="0.5"
"threadcount"="6"
"scanproportion"="0"
"insertproportion"="0"
"mysql.host"="192.168.0.19"
"requestdistribution"="uniform"
"operationcount"="1000"
"mysql.port"="4000"
**********************************************
INSERT - Takes(s): 9.3, Count: 241, OPS: 26.0, Avg(us): 246490, Min(us): 95576, Max(us): 772518, 99th(us): 765000, 99.9th(us): 773000, 99.99th(us): 773000
INSERT - Takes(s): 19.3, Count: 463, OPS: 24.0, Avg(us): 255764, Min(us): 95576, Max(us): 772518, 99th(us): 764000, 99.9th(us): 773000, 99.99th(us): 773000
......
INSERT - Takes(s): 619.3, Count: 9996, OPS: 16.1, Avg(us): 268387, Min(us): 47080, Max(us): 2597853, 99th(us): 844000, 99.9th(us): 1985000, 99.99th(us): 2598000
INSERT - Takes(s): 629.3, Count: 9996, OPS: 15.9, Avg(us): 268387, Min(us): 47080, Max(us): 2597853, 99th(us): 844000, 99.9th(us): 1985000, 99.99th(us): 2598000
INSERT - Takes(s): 636.2, Count: 9996, OPS: 15.7, Avg(us): 268387, Min(us): 47080, Max(us): 2597853, 99th(us): 844000, 99.9th(us): 1985000, 99.99th(us): 2598000
Run finished, takes 10m36.974488977s
```

- workloada 负载类型测试
```
***************** properties *****************
"threadcount"="6"
"scanproportion"="0"
"updateproportion"="0.5"
"workload"="core"
"insertproportion"="0"
"recordcount"="1000"
"readallfields"="true"
"mysql.host"="192.168.0.19"
"mysql.port"="4000"
"dotransactions"="true"
"readproportion"="0.5"
"requestdistribution"="uniform"
"operationcount"="10000"
**********************************************
READ   - Takes(s): 10.0, Count: 278, OPS: 27.8, Avg(us): 4721, Min(us): 3700, Max(us): 109901, 99th(us): 14000, 99.9th(us): 110000, 99.99th(us): 110000
UPDATE - Takes(s): 9.9, Count: 302, OPS: 30.6, Avg(us): 191180, Min(us): 89797, Max(us): 763569, 99th(us): 394000, 99.9th(us): 764000, 99.99th(us): 764000
......
UPDATE - Takes(s): 159.9, Count: 5004, OPS: 31.3, Avg(us): 185761, Min(us): 62082, Max(us): 1247838, 99th(us): 392000, 99.9th(us): 1113000, 99.99th(us): 1248000
READ   - Takes(s): 166.7, Count: 4914, OPS: 29.5, Avg(us): 4343, Min(us): 3462, Max(us): 109901, 99th(us): 7000, 99.9th(us): 48000, 99.99th(us): 110000
UPDATE - Takes(s): 166.6, Count: 5082, OPS: 30.5, Avg(us): 185421, Min(us): 62082, Max(us): 1247838, 99th(us): 392000, 99.9th(us): 1113000, 99.99th(us): 1248000
Run finished, takes 2m46.716890799s
```

- workloadb 负载类型测试
```
# ./bin/go-ycsb run mysql -P workloads/workloadb -p operationcount=10000 -p mysql.host=192.168.0.19 -p mysql.port=4000 --threads 6 
***************** properties *****************
"updateproportion"="0.05"
"insertproportion"="0"
"mysql.host"="192.168.0.19"
"recordcount"="1000"
"workload"="core"
"scanproportion"="0"
"requestdistribution"="uniform"
"readallfields"="true"
"mysql.port"="4000"
"threadcount"="6"
"dotransactions"="true"
"operationcount"="10000"
"readproportion"="0.95"
**********************************************
READ   - Takes(s): 10.0, Count: 4957, OPS: 496.1, Avg(us): 4030, Min(us): 3351, Max(us): 57976, 99th(us): 6000, 99.9th(us): 46000, 99.99th(us): 58000
UPDATE - Takes(s): 9.9, Count: 261, OPS: 26.5, Avg(us): 151054, Min(us): 56658, Max(us): 597913, 99th(us): 304000, 99.9th(us): 598000, 99.99th(us): 598000
READ   - Takes(s): 20.0, Count: 9487, OPS: 474.5, Avg(us): 4012, Min(us): 3351, Max(us): 57976, 99th(us): 6000, 99.9th(us): 39000, 99.99th(us): 58000
UPDATE - Takes(s): 19.9, Count: 502, OPS: 25.3, Avg(us): 149276, Min(us): 56658, Max(us): 597913, 99th(us): 291000, 99.9th(us): 598000, 99.99th(us): 598000
Run finished, takes 20.046772704s
READ   - Takes(s): 20.0, Count: 9493, OPS: 473.8, Avg(us): 4012, Min(us): 3351, Max(us): 57976, 99th(us): 6000, 99.9th(us): 39000, 99.99th(us): 58000
UPDATE - Takes(s): 19.9, Count: 503, OPS: 25.3, Avg(us): 149217, Min(us): 56658, Max(us): 597913, 99th(us): 291000, 99.9th(us): 598000, 99.99th(us): 598000
```

- workloadc 负载类型测试
```
# ./bin/go-ycsb run mysql -P workloads/workloadc -p operationcount=10000 -p mysql.host=192.168.0.19 -p mysql.port=4000 --threads 6 
***************** properties *****************
"mysql.host"="192.168.0.19"
"scanproportion"="0"
"mysql.port"="4000"
"dotransactions"="true"
"insertproportion"="0"
"recordcount"="1000"
"operationcount"="10000"
"readproportion"="1"
"readallfields"="true"
"updateproportion"="0"
"requestdistribution"="uniform"
"workload"="core"
"threadcount"="6"
**********************************************
Run finished, takes 6.632479755s
READ   - Takes(s): 6.6, Count: 9996, OPS: 1509.1, Avg(us): 3915, Min(us): 3262, Max(us): 18492, 99th(us): 7000, 99.9th(us): 13000, 99.99th(us): 19000
```

- workloadd 负载类型测试
```
# ./bin/go-ycsb run mysql -P workloads/workloadd -p operationcount=10000 -p mysql.host=192.168.0.19 -p mysql.port=4000 --threads 6 
***************** properties *****************
"dotransactions"="true"
"operationcount"="10000"
"readallfields"="true"
"requestdistribution"="latest"
"recordcount"="1000"
"updateproportion"="0"
"scanproportion"="0"
"mysql.port"="4000"
"insertproportion"="0.05"
"workload"="core"
"threadcount"="6"
"mysql.host"="192.168.0.19"
"readproportion"="0.95"
**********************************************
Run finished, takes 6.509929303s
INSERT - Takes(s): 6.5, Count: 507, OPS: 78.1, Avg(us): 3192, Min(us): 2696, Max(us): 6492, 99th(us): 6000, 99.9th(us): 7000, 99.99th(us): 7000
READ   - Takes(s): 6.5, Count: 9489, OPS: 1459.7, Avg(us): 3882, Min(us): 3202, Max(us): 43528, 99th(us): 7000, 99.9th(us): 12000, 99.99th(us): 44000
```

- workloade 负载类型测试
```
# ./bin/go-ycsb run mysql -P workloads/workloade -p operationcount=10000 -p mysql.host=192.168.0.19 -p mysql.port=4000 --threads 6  
***************** properties *****************
"readproportion"="0"
"scanproportion"="0.95"
"updateproportion"="0"
"scanlengthdistribution"="uniform"
"recordcount"="1000"
"requestdistribution"="uniform"
"dotransactions"="true"
"maxscanlength"="1"
"operationcount"="10000"
"threadcount"="6"
"mysql.host"="192.168.0.19"
"mysql.port"="4000"
"workload"="core"
"readallfields"="true"
"insertproportion"="0.05"
**********************************************
Run finished, takes 8.437509693s
INSERT - Takes(s): 8.4, Count: 460, OPS: 54.7, Avg(us): 3595, Min(us): 2839, Max(us): 10975, 99th(us): 8000, 99.9th(us): 11000, 99.99th(us): 11000
SCAN   - Takes(s): 8.4, Count: 9536, OPS: 1131.5, Avg(us): 5081, Min(us): 3854, Max(us): 27548, 99th(us): 12000, 99.9th(us): 17000, 99.99th(us): 28000
```

- workloadf 负载类型测试
```
***************** properties *****************
"workload"="core"
"recordcount"="1000"
"readproportion"="0.5"
"readallfields"="true"
"operationcount"="10000"
"mysql.host"="192.168.0.19"
"threadcount"="6"
"readmodifywriteproportion"="0.5"
"insertproportion"="0"
"requestdistribution"="uniform"
"dotransactions"="true"
"scanproportion"="0"
"mysql.port"="4000"
"updateproportion"="0"
**********************************************
READ   - Takes(s): 10.0, Count: 363, OPS: 36.3, Avg(us): 4563, Min(us): 3494, Max(us): 105993, 99th(us): 7000, 99.9th(us): 106000, 99.99th(us): 106000
READ_MODIFY_WRITE - Takes(s): 9.8, Count: 183, OPS: 18.7, Avg(us): 320355, Min(us): 110273, Max(us): 968213, 99th(us): 914000, 99.9th(us): 969000, 99.99th(us): 969000
UPDATE - Takes(s): 9.8, Count: 183, OPS: 18.7, Avg(us): 315478, Min(us): 105895, Max(us): 963991, 99th(us): 910000, 99.9th(us): 964000, 99.99th(us): 964000
......
READ   - Takes(s): 200.2, Count: 9996, OPS: 49.9, Avg(us): 4470, Min(us): 3414, Max(us): 140687, 99th(us): 7000, 99.9th(us): 106000, 99.99th(us): 141000
READ_MODIFY_WRITE - Takes(s): 200.0, Count: 4955, OPS: 24.8, Avg(us): 229851, Min(us): 63001, Max(us): 1275586, 99th(us): 516000, 99.9th(us): 914000, 99.99th(us): 1276000
UPDATE - Takes(s): 200.0, Count: 4955, OPS: 24.8, Avg(us): 225368, Min(us): 59010, Max(us): 1271673, 99th(us): 512000, 99.9th(us): 910000, 99.99th(us): 1272000
Run finished, takes 3m20.20520338s
```

### go-tpc 基准性能测试
1. go-tpc 工具安装
```
# git clone https://github.com/pingcap/go-tpc.git
# cd go-tpc/
# make build
```

2. TPC-C 性能测试
- 准备数据
```
# ./bin/go-tpc tpcc -H 192.168.0.19 -P 4000 -D tpcc --warehouses 10 prepare 
```

- 运行测试
```
# ./bin/go-tpc tpcc -H 192.168.0.19 -P 4000 -D tpcc --warehouses 10 run
```

3. TPC-H 性能测试
- 准备数据
```
# ./bin/go-tpc tpch prepare -H 192.168.0.19 -P 4000 -D tpch --sf 50 --analyze
```

- 运行测试
```
# ./bin/go-tpc tpch run -H 192.168.0.19 -P 4000 -D tpch --sf 50
```
